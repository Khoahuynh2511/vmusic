/**
 * ========================================
 * SLEEP TIMER MODULE - H·∫πn gi·ªù t·∫Øt nh·∫°c
 * ========================================
 * Ch·ª©c nƒÉng: Qu·∫£n l√Ω timer ƒë·ªÉ t·ª± ƒë·ªông d·ª´ng ph√°t nh·∫°c
 * - Thi·∫øt l·∫≠p timer (5, 10, 30, 60 ph√∫t)
 * - Countdown display
 * - Auto pause music when timer expires
 * - Cancel timer functionality
 */

class SleepTimer {
    constructor(player) {
        this.player = player;
        this.timerId = null;
        this.remainingTime = 0;
        this.isActive = false;
        
        this.modal = null;
        this.timerStatusDiv = null;
        this.timerTextSpan = null;
        this.cancelButton = null;
        
        this.updateInterval = null;
        
        this.init();
    }

    /**
     * Kh·ªüi t·∫°o sleep timer
     */
    init() {
        this.modal = new bootstrap.Modal(document.getElementById('sleepTimerModal'));
        this.timerStatusDiv = document.getElementById('timer-status');
        this.timerTextSpan = document.getElementById('timer-text');
        this.cancelButton = document.getElementById('cancel-timer');
        
        this.bindEvents();
        console.log('‚úÖ Sleep Timer ƒë√£ kh·ªüi t·∫°o');
    }

    /**
     * G·∫Øn event listeners
     */
    bindEvents() {
        // N√∫t m·ªü sleep timer modal
        const sleepTimerBtn = document.getElementById('sleep-timer-btn');
        if (sleepTimerBtn) {
            sleepTimerBtn.addEventListener('click', () => {
                this.showModal();
            });
        }

        // C√°c n√∫t thi·∫øt l·∫≠p timer
        const timerOptions = document.querySelectorAll('.sleep-timer-option');
        timerOptions.forEach(button => {
            button.addEventListener('click', (e) => {
                const minutes = parseInt(e.target.dataset.minutes);
                this.setTimer(minutes);
            });
        });

        // N√∫t h·ªßy timer
        if (this.cancelButton) {
            this.cancelButton.addEventListener('click', () => {
                this.cancelTimer();
            });
        }

        // Keyboard shortcut: Ctrl + Shift + S
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                this.showModal();
            }
        });
    }

    /**
     * Hi·ªÉn th·ªã modal sleep timer
     */
    showModal() {
        this.updateModalUI();
        this.modal.show();
    }

    /**
     * Thi·∫øt l·∫≠p timer
     * @param {number} minutes - S·ªë ph√∫t
     */
    setTimer(minutes) {
        // H·ªßy timer c≈© n·∫øu c√≥
        this.cancelTimer();
        
        this.remainingTime = minutes * 60; // Convert to seconds
        this.isActive = true;
        
        // B·∫Øt ƒë·∫ßu countdown
        this.startCountdown();
        
        // Thi·∫øt l·∫≠p timer ch√≠nh
        this.timerId = setTimeout(() => {
            this.onTimerExpired();
        }, minutes * 60 * 1000);

        // C·∫≠p nh·∫≠t UI
        this.updateModalUI();
        this.updateSleepTimerButton();
        
        // ƒê√≥ng modal
        this.modal.hide();
        
        // Hi·ªán th√¥ng b√°o
        this.showNotification(`‚è∞ ƒê√£ thi·∫øt l·∫≠p h·∫πn gi·ªù ${minutes} ph√∫t`);
        
        console.log(`‚è∞ Sleep timer ƒë√£ thi·∫øt l·∫≠p: ${minutes} ph√∫t`);
    }

    /**
     * B·∫Øt ƒë·∫ßu countdown
     */
    startCountdown() {
        this.updateInterval = setInterval(() => {
            this.remainingTime--;
            
            if (this.remainingTime <= 0) {
                this.clearCountdown();
                return;
            }
            
            this.updateTimerDisplay();
            this.updateSleepTimerButton();
            
            // C·∫£nh b√°o khi c√≤n 1 ph√∫t
            if (this.remainingTime === 60) {
                this.showNotification('‚ö†Ô∏è C√≤n 1 ph√∫t n·ªØa s·∫Ω t·∫Øt nh·∫°c!', 'warning');
            }
            
            // C·∫£nh b√°o khi c√≤n 30 gi√¢y
            if (this.remainingTime === 30) {
                this.showNotification('‚ö†Ô∏è C√≤n 30 gi√¢y n·ªØa s·∫Ω t·∫Øt nh·∫°c!', 'warning');
            }
            
        }, 1000);
    }

    /**
     * X√≥a countdown interval
     */
    clearCountdown() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }

    /**
     * X·ª≠ l√Ω khi timer h·∫øt h·∫°n
     */
    onTimerExpired() {
        console.log('‚è∞ Sleep timer ƒë√£ h·∫øt h·∫°n - ƒêang d·ª´ng nh·∫°c...');
        
        // D·ª´ng nh·∫°c
        if (this.player && this.player.pause) {
            this.player.pause();
        }
        
        // Fade out volume
        this.fadeOutVolume();
        
        // Reset timer
        this.resetTimer();
        
        // Hi·ªán th√¥ng b√°o
        this.showNotification('üò¥ ƒê√£ t·∫Øt nh·∫°c theo h·∫πn gi·ªù. Ch√∫c b·∫°n ng·ªß ngon!', 'success');
        
        // Dispatch custom event
        this.dispatchTimerExpiredEvent();
    }

    /**
     * Fade out √¢m l∆∞·ª£ng tr∆∞·ªõc khi d·ª´ng
     */
    fadeOutVolume() {
        if (!this.player || !this.player.audio) return;
        
        const audio = this.player.audio;
        const originalVolume = audio.volume;
        const fadeStep = originalVolume / 20; // 20 steps
        
        const fadeInterval = setInterval(() => {
            if (audio.volume > fadeStep) {
                audio.volume -= fadeStep;
            } else {
                audio.volume = 0;
                clearInterval(fadeInterval);
                
                // Kh√¥i ph·ª•c volume sau khi d·ª´ng
                setTimeout(() => {
                    audio.volume = originalVolume;
                }, 2000);
            }
        }, 100);
    }

    /**
     * H·ªßy timer
     */
    cancelTimer() {
        if (this.timerId) {
            clearTimeout(this.timerId);
            this.timerId = null;
        }
        
        this.clearCountdown();
        this.resetTimer();
        this.updateModalUI();
        this.updateSleepTimerButton();
        
        if (this.isActive) {
            this.showNotification('‚ùå ƒê√£ h·ªßy h·∫πn gi·ªù t·∫Øt nh·∫°c');
        }
        
        console.log('‚ùå Sleep timer ƒë√£ b·ªã h·ªßy');
    }

    /**
     * Reset timer v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
     */
    resetTimer() {
        this.isActive = false;
        this.remainingTime = 0;
        this.timerId = null;
    }

    /**
     * C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªùi gian c√≤n l·∫°i
     */
    updateTimerDisplay() {
        if (!this.timerTextSpan) return;
        
        const minutes = Math.floor(this.remainingTime / 60);
        const seconds = this.remainingTime % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        this.timerTextSpan.textContent = `C√≤n ${timeString} s·∫Ω t·∫Øt nh·∫°c`;
    }

    /**
     * C·∫≠p nh·∫≠t UI c·ªßa modal
     */
    updateModalUI() {
        if (!this.timerStatusDiv) return;
        
        if (this.isActive) {
            this.timerStatusDiv.classList.remove('d-none');
            this.updateTimerDisplay();
        } else {
            this.timerStatusDiv.classList.add('d-none');
        }
    }

    /**
     * C·∫≠p nh·∫≠t n√∫t sleep timer ch√≠nh
     */
    updateSleepTimerButton() {
        const sleepTimerBtn = document.getElementById('sleep-timer-btn');
        if (!sleepTimerBtn) return;
        
        const icon = sleepTimerBtn.querySelector('i');
        const text = sleepTimerBtn.querySelector('span');
        
        if (this.isActive) {
            icon.className = 'bi bi-clock-fill';
            const minutes = Math.floor(this.remainingTime / 60);
            const seconds = this.remainingTime % 60;
            text.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            sleepTimerBtn.classList.remove('btn-outline-info');
            sleepTimerBtn.classList.add('btn-outline-warning');
            sleepTimerBtn.classList.add('pulse');
        } else {
            icon.className = 'bi bi-clock';
            text.textContent = 'Sleep Timer';
            sleepTimerBtn.classList.remove('btn-outline-warning');
            sleepTimerBtn.classList.add('btn-outline-info');
            sleepTimerBtn.classList.remove('pulse');
        }
    }

    /**
     * Hi·ªán th√¥ng b√°o toast
     * @param {string} message - N·ªôi dung th√¥ng b√°o
     * @param {string} type - Lo·∫°i th√¥ng b√°o (success, warning, error)
     */
    showNotification(message, type = 'info') {
        const toastElement = document.getElementById('notification-toast');
        const toastBody = document.getElementById('toast-message');
        
        if (toastElement && toastBody) {
            toastBody.textContent = message;
            
            // Th√™m class t∆∞∆°ng ·ª©ng v·ªõi type
            toastElement.className = `toast show`;
            if (type === 'warning') {
                toastElement.classList.add('bg-warning');
            } else if (type === 'success') {
                toastElement.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastElement.classList.add('bg-danger', 'text-white');
            }
            
            const toast = new bootstrap.Toast(toastElement, {
                delay: type === 'warning' ? 5000 : 3000
            });
            toast.show();
        }
    }

    /**
     * Dispatch custom event khi timer h·∫øt h·∫°n
     */
    dispatchTimerExpiredEvent() {
        const event = new CustomEvent('sleeptimerexpired', {
            detail: {
                timestamp: Date.now(),
                action: 'music_paused'
            }
        });
        document.dispatchEvent(event);
    }

    /**
     * L·∫•y th√¥ng tin timer hi·ªán t·∫°i
     * @returns {Object}
     */
    getTimerInfo() {
        return {
            isActive: this.isActive,
            remainingTime: this.remainingTime,
            remainingMinutes: Math.floor(this.remainingTime / 60),
            remainingSeconds: this.remainingTime % 60,
            startTime: this.isActive ? Date.now() : null
        };
    }

    /**
     * Ki·ªÉm tra timer c√≥ ƒëang ho·∫°t ƒë·ªông kh√¥ng
     * @returns {boolean}
     */
    isTimerActive() {
        return this.isActive;
    }

    /**
     * Extend timer th√™m th·ªùi gian
     * @param {number} additionalMinutes
     */
    extendTimer(additionalMinutes) {
        if (!this.isActive) return false;
        
        this.remainingTime += additionalMinutes * 60;
        
        // H·ªßy timer c≈© v√† t·∫°o timer m·ªõi
        if (this.timerId) {
            clearTimeout(this.timerId);
            this.timerId = setTimeout(() => {
                this.onTimerExpired();
            }, this.remainingTime * 1000);
        }
        
        this.showNotification(`‚è∞ ƒê√£ gia h·∫°n th√™m ${additionalMinutes} ph√∫t`);
        return true;
    }

    /**
     * H·ªßy sleep timer
     */
    destroy() {
        this.cancelTimer();
        console.log('üßπ Sleep Timer ƒë√£ ƒë∆∞·ª£c h·ªßy');
    }
}

// Export ƒë·ªÉ app.js s·ª≠ d·ª•ng
window.SleepTimer = SleepTimer; 